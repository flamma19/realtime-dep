FROM supabase/realtime:latest

ENV PORT=4000
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=5432
ENV DB_USER=postgres
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_NAME=postgres
ENV DB_ENC_KEY=supabaserealtime
ENV DB_AFTER_CONNECT_QUERY='SET search_path TO _realtime'
ENV API_JWT_SECRET=${JWT_SECRET}
ENV FLY_ALLOC_ID=fly123
ENV FLY_APP_NAME=realtime
ENV SECRET_KEY_BASE=UpNVntn3cDxHJpq99YMc1T1AQgQpc8kfYTuRgBiYa15BLrx8etQoXz3gZv1/u2oq
ENV ERL_AFLAGS="-proto_dist inet_tcp"
ENV ENABLE_TAILSCALE="false"
ENV RLIMIT_NOFILE=1000000
ENV DNS_NODES="''"
ENV ENABLE_ERL_CRASH_DUMP=true
ENV ERL_CRASH_DUMP_FOLDER=/tmp
ENV ERL_CRASH_DUMP_FILE_NAME=erl_crash.dump
ENV ERL_CRASH_DUMP_S3_ENDPOINT=http://minio:9000
ENV ERL_CRASH_DUMP_S3_REGION=us-east-1
ENV ERL_CRASH_DUMP_S3_BUCKET=realtime
ENV ERL_CRASH_DUMP_S3_KEY=minio-access-key
ENV ERL_CRASH_DUMP_S3_SECRET=minio-secret-key
ENV ERL_CRASH_DUMP_S3_HOST=minio
ENV ERL_CRASH_DUMP_S3_PORT=9000
ENV ERL_CRASH_DUMP_S3_SSL=false

EXPOSE 4000

CMD sh -c "/app/bin/migrate && /app/bin/realtime eval 'Realtime.Release.seeds(Realtime.Repo)' && /app/bin/server"